Date.now||(Date.now=function(){return(new Date).getTime()});exists(window.Game)||(Game={});
Game.Manager=function(){GameManager=function(){this.running=!1;this.objects={active:[],toAdd:[],toRemove:[]};this.now=0;this.gameMap=null;this.framesSkipped=this.skipFrames=0};GameManager.prototype.setMap=function(b){this.gameMap=b};GameManager.prototype.createMap=function(b,a,d,g){this.gameMap=new Game.Map(b,a,d);this.gameMap.setBgColor(exists(g)?g:"#000")};GameManager.prototype.getMap=function(){return this.gameMap};GameManager.prototype.getObjects=function(b){return b?this.objects.active.filter(b):
this.objects.active};var d=function(b,a){return a instanceof b};GameManager.prototype.getInstancesOf=function(b){return b?this.getObjects(d.bind(void 0,b)):this.getObjects()};GameManager.prototype.addObject=function(b){this.objects.toAdd.indexOf(-1==b)?this.objects.toAdd.push(b):console.log(Error("the object "+b+" is already being added from the game").stack)};GameManager.prototype.removeObject=function(b){this.objects.toRemove.indexOf(-1===b)?this.objects.toRemove.push(b):console.log(Error("the object "+
b+" is already being removed from the game").stack)};GameManager.prototype.clearObjects=function(){for(var b=this.objects.active.length;0<=b;b--)this.removeObject(this.objects.active[b])};GameManager.prototype.start=function(){this.running=!0;this.now=0;if(!isNull(this.gameEventsListener)&&!isNull(this.gameEventsListener.onStart))this.gameEventsListener.onStart(this);requestAnimationFrame(this.onFrame.bind(this))};GameManager.prototype.stop=function(){this.running=!1;if(!isNull(this.gameEventsListener)&&
!isNull(this.gameEventsListener.onStop))this.gameEventsListener.onStop(this)};GameManager.prototype.setSkipFramesNumber=function(b){this.skipFrames=b};GameManager.prototype.setGameEventsListener=function(b){this.gameEventsListener=b};GameManager.prototype.getGameEventsListener=function(){return this.gameEventsListener};GameManager.prototype.onFrame=function(b){if(this.running){if(0===this.now){this.now=b;requestAnimationFrame(this.onFrame.bind(this));return}for(var a,d=this.objects.active,g=this.objects.toAdd,
f=this.objects.toRemove,h=f.length;h--;)a=f.pop(),a.onDeath(this),a=d.indexOf(a),-1<a&&d.splice(a,1);f=(b-this.now)/1E3;if(0===f){console.log("error : dT=0");return}if(this.skipFrames){if(this.framesSkipped<this.skipFrames){this.framesSkipped++;requestAnimationFrame(this.onFrame.bind(this));return}this.framesSkipped=0}this.now=b;if(0!==f&&.5>f){var l;b=d.filter(Game.objects.Object.collisionFilter);var k;a=h=b.length;if(0<a){for(;h--;)b[h].prepareCollision();for(h=a;h--;){a=b.pop();k=b.filter(Game.objects.Object.getCollisionLayerFilter(a.collisionLayers,
!0));l=k.length;if(0<l)for(;l--;)a!==k[l]&&a.canCollide(k[l])&&k[l].canCollide(a)&&a.collides(k[l])&&(a.onCollision(this,k[l]),k[l].onCollision(this,a));a.finishCollision()}}h=g.length;if(0<h)for(;h--;)d.push(g.pop());h=d.length;if(0<h)for(;h--;)d[h].onFrame(this,f)}if(!isNull(this.gameEventsListener)&&!isNull(this.gameEventsListener.onFrame))this.gameEventsListener.onFrame(this,f)}this.gameMap&&this.gameMap.render(this,this.objects.active);requestAnimationFrame(this.onFrame.bind(this))};GameManager.prototype.showContextMenu=
function(b){b=""+this.gameMap.getContextMenu();var a=this.gameMap.getObjectAt(this.gameMap.gameCoordsFromPixelCoords(position));isNull(a)||(b+=a.getContextMenu());menu.innerHtml=b+""};return GameManager}();Game.Map=function(){var d=function(b,a,d){this.context=b.getContext("2d");this.context.font="20px Verdana";this.gameWidth=a||b.width;this.gameHeight=d||b.height;this.visibleRect=new Rect(0,0,this.gameWidth,this.gameHeight)};d.prototype.setBgColor=function(b){this.context.canvas.style.background=b};d.prototype.getBg=function(){return this.context.canvas.style.background};d.prototype.setPointerPosition=function(b){this.pointerPos?this.pointerPos.set(b):this.pointerPos=b.clone();b=this.getHud();isNull(b)||
b.mouseMove(this.pointerPos)};d.prototype.getPointerPosition=function(){return this.pointerPos?this.pointerPos:Vec2.ZERO};d.prototype.autoResize=function(b,a){exists(b)?typeof b==TYPE_NUMBER&&(a=b,b=!0):(b=!0,a=0);this.onWindowResize&&(window.removeEventListener("resize",this.onWindowNormalSize,!1),document.removeEventListener("fullscreenchange",this.onWindowFullSize,!1));if(b){var d=this.context.canvas.parentNode;typeof a!=TYPE_NUMBER&&(a=0);document.body.style.margin=0;
var g=this.getVisibleRect().ratio();this.onWindowResize=function(b,h){var l=d.offsetWidth,k=d.offsetHeight,m=l-a,n=Math.min(k-a,m/g),m=n*g;this.setSize(m,n,(l-m)/2,(k-n)/2)};this.onWindowFullSize=this.onWindowResize.bind(this,!0);this.onWindowNormalSize=this.onWindowResize.bind(this,!1);window.addEventListener("resize",this.onWindowNormalSize,!1);document.addEventListener("fullscreenchange",this.onWindowFullSize,!1);this.onWindowResize()}};d.prototype.setSize=function(b,a,d,g){var f=b/this.visibleRect.width(),
h=a/this.visibleRect.height();this.context.canvas.width=b;this.context.canvas.height=a;this.context.canvas.style.marginLeft=d.toString()+"px";this.context.canvas.style.marginTop=g.toString()+"px";this.context.transform(f,0,0,h,0,0);isNull(hud=this.getHud())||isNull(c=hud.getContext())||(c.width=b,c.height=a,c.canvas.style.marginLeft=d.toString()+"px",c.canvas.style.marginTop=g.toString()+"px",c.transform(f,0,0,h,0,0))};d.prototype.setVisibleRect=function(b){this.visibleRect.set(b);var a=b.width();
b=b.height();this.context.transform(a?this.contexts[0].canvas.width/a:1,0,0,b?this.contexts[0].canvas.height/b:1,0,0)};d.prototype.getVisibleRect=function(){return this.visibleRect};d.prototype.getGameRect=function(){return new Rect(0,0,this.gameWidth,this.gameHeight)};d.prototype.gameCoordsFromPixelCoords=function(b,a){var d=this.getGamePixelScaleX(),g=this.getGamePixelScaleY(),f=this.getVisibleRect().left,h=this.getVisibleRect().top;isNull(a)&&(a={});a.x=b.x*d+f;a.y=b.y*g+h;return a};d.prototype.pixelCoordsFromGameCoords=
function(b,a){this.getGamePixelScaleX();this.getGamePixelScaleY();var d=this.getVisibleRect().left,g=this.getVisibleRect().top;isNull(a)&&(a={});return a.set((b.x-d)*scale,b.y-g)};d.prototype.getGamePixelScaleX=function(){return this.getVisibleRect().width()/this.context.canvas.width};d.prototype.getGamePixelScaleY=function(){return this.getVisibleRect().height()/this.context.canvas.height};d.prototype.setHud=function(b){this.hud=b};d.prototype.createHud=function(){this.hud=new Game.hud.Hud};d.prototype.getHud=
function(){return this.hud};d.prototype.showDebug=function(b){this.debug=b};d.prototype.isDebug=function(){return this.debug};d.prototype.renderDebug=function(b){};d.LAYER_NONE=-1;d.LAYER_BG1=0;d.LAYER_BG2=1;d.LAYER_BG3=2;d.LAYER_OBJ1=3;d.LAYER_OBJ2=4;d.LAYER_OBJ3=5;d.LAYER_PARTCILES=6;d.LAYER_MAX=6;d.LAYER_MIN=0;d.prototype.getContext=function(){return this.context};d.prototype.render=function(b,a){var e=this.getVisibleRect(),g,f=this.context;f.clearRect(0,0,e.width(),e.height());var h=b.getGameEventsListener();
h&&h.onRenderStart&&(f.save(),h.onRenderStart(b,f));var l=d.LAYER_MIN-1;for(f.save();l++<d.LAYER_MAX;){g=a.filter(GameObject.renderLayerFilter.bind(void 0,l));for(var k=g.length;k--;)g[k].isOutOfMap(e)||g[k].render(f);if(this.debug){for(k=g.length;k--;)g[k].isOutOfMap(e)||g[k].renderDebug(f);l==d.LAYER_BG3&&this.renderDebug(f)}}f.restore();(g=this.getHud())&&!g.getContext()&&(f.save(),this.getHud().render(f,e),f.restore());this.showMouseOverInfos(b,a,f);h&&h.onRenderEnd&&(h.onRenderEnd(b,f),f.restore())};
d.prototype.getObjectAt=function(b,a){for(var d=null,g=-1,f,h,l=b.length,k;l--;)k=b[l],isNull(k.renderMouseOver)||(f=k.getPosition()),isNull(f)||(h=Vec2.distance(f,a),(-1==g||h<g)&&k.getRenderRect().contains(a)&&(d=k,g=h));return d};d.prototype.getContextMenu=function(){return""};d.prototype.showMouseOverInfos=function(b,a,d){d||(d=this.context);isNull(this.pointerPos)||(a=this.getObjectAt(a,this.pointerPos),isNull(a)||a.renderMouseOver(d,this.pointerPos,b,this.debug))};return d}();Game.objects={};
Game.objects.Object=function(){GameObject=function(){};GameObject.prototype.onFrame=function(d,b){this.moveOnFrame(d,b);this.accelerateOnFrame(d,b);this.rotateOnFrame(d,b);this.mustKeepInRect()&&this.maintainInRect(d.gameMap.getVisibleRect())};GameObject.prototype.moveOnFrame=function(d,b){var a=this.getSpeed();a&&!a.isZero()&&this.move(a.clone().mul(b))};GameObject.prototype.accelerateOnFrame=function(d,b){var a=this.getAcceleration();a&&!a.isZero()&&this.accelerate(a.clone().mul(b))};GameObject.prototype.rotateOnFrame=
function(d,b){var a=this.getRotationSpeed();a&&this.rotate(a*b)};GameObject.prototype.setRotationFieldEnabled=function(d){d&&!this.radians?this.radians=0:!d&&exists(this.radians)&&delete this.radians;return this};GameObject.prototype.rotate=function(d){exists(this.radians)&&(this.radians=(this.radians+d)%(2*Math.PI));this.renderer&&this.renderer.rotate(d);this.collider&&this.collider.rotate(d);return this};GameObject.prototype.setRadians=function(d){typeof d!=TYPE_NUMBER?console.log("cannot set radians to "+
d):(exists(this.radians)||this.setRotationFieldEnabled(!0),this.rotate(d-this.radians))};GameObject.prototype.getRadians=function(){return this.radians||0};GameObject.prototype.getDirection=function(){return Vec2.createFromRadians(this.getRadians())};GameObject.prototype.lookAt=function(d){exists(this.radians)||this.setRotationFieldEnabled(!0);d=Vec2.translation(this.getPosition(),d);this.setRadians(d.getAngle());return this};GameObject.prototype.setRotationSpeed=function(d){d?this.rotationSpeed=
d:this.rotationSpeed&&delete this.rotationSpeed;return this};GameObject.prototype.getRotationSpeed=function(){return this.rotationSpeed||0};GameObject.prototype.grow=function(d){this.renderer&&this.renderer.grow(d);this.collider&&this.collider.grow(d);return this};GameObject.prototype.setRenderer=function(d){this.renderer=d;return this};GameObject.prototype.getRenderer=function(){return this.renderer};GameObject.prototype.render=function(d){this.renderer&&this.renderer.render(this.getPosition(),d)};
GameObject.prototype.renderDebug=function(d){this.collider&&this.collider.render(this.getPosition(),d)};GameObject.prototype.renderMouseOver=function(d,b,a,e){!a.running&&e&&(b=this.getRect(),d.fillStyle="#fff",d.font="15px Verdana",e=this.getInformations(),a=a.getMap().getVisibleRect(),a.right-b.right<b.left-a.left?(b.right=b.left,b.left=a.left,a=Gravity.RIGHT):(b.left=b.right,b.right=a.right,a=Gravity.LEFT),d.wrapText(e.join("\n"),b,15,a,!0,!1));d.strokeStyle="#fff";(new Circle(this.getPosition(),
1.1*this.getRenderRadius())).draw(d,!1,!0)};GameObject.prototype.getInformations=function(){var d=this.getPosition(),b=this.getSpeed(),a=this.getAcceleration(),e=[];d&&e.push(["p :",d.roundedVec(4)].join(" "));b&&e.push(["s :",b.roundedVec(4)].join(" "));a&&e.push(["a :",a.roundedVec(4)].join(" "));return e};GameObject.prototype.getContextMenu=function(){return""};GameObject.prototype.renderLayer=Game.Map.LAYER_OBJ1;GameObject.renderLayerFilter=function(d,b){return b.renderLayer==d};GameObject.prototype.setCollider=
function(d){this.collider=d;return this};GameObject.prototype.getCollider=function(){return this.collider};GameObject.prototype.canCollide=function(){return!isNull(this.getCollider())};GameObject.prototype.prepareCollision=function(){this.collision||(this.collision={});this.collision.position=this.getPosition();this.collision.collider=this.getCollider();this.collision.collider.prepareCollision(this.collision)};GameObject.prototype.finishCollision=function(){this.collision.collider.finishCollision()};
GameObject.prototype.collides=function(d){return this.collision.position&&d.collision.position&&this.collision.collider.collides(this.collision,d.collision)};GameObject.prototype.onCollision=function(d,b){};GameObject.COLLISION_LAYER=1;GameObject.prototype.collisionLayers=[GameObject.COLLISION_LAYER];GameObject.prototype.isInLayer=function(d){return 0<=this.collisionLayers.indexOf(d)};GameObject.getCollisionLayerFilter=function(d,b){var a=d.length;if(1<a)return b?function(b){var e=a;for(b=b.collisionLayers;e--&&
-1==b.indexOf(d[e]););return 0<=e}:function(b){var e=a;for(b=b.collisionLayers;e--&&-1==b.indexOf(d[e]););return-1==e};if(a){var e=d[0];return b?function(a){return 0<=a.collisionLayers.indexOf(e)}:function(a){return-1==a.collisionLayers.indexOf(e)}}return function(a){return!b}};GameObject.NO_COLLISION_LAYER=-1;GameObject.collisionFilter=GameObject.getCollisionLayerFilter([-1],!1);GameObject.prototype.getRect=function(){return Rect.getUnion([this.getRenderRect(),this.getColliderRect()])};GameObject.prototype.getColliderRect=
function(){var d=this.getCollider();return d?d.getRect(this.getPosition()):Rect.createFromPoint(this.getPosition())};GameObject.prototype.getRenderRect=function(){var d=this.getRenderer();return d?d.getRect(this.getPosition()):Rect.createFromPoint(this.getPosition())};GameObject.prototype.getRadius=function(){return Math.max(this.getRenderRadius(),this.getColliderRadius())};GameObject.prototype.getRenderRadius=function(){var d=this.getRenderer();return d?d.getRadius():0};GameObject.prototype.getColliderRadius=
function(){var d=this.getCollider();return d?d.getRadius():0};GameObject.prototype.getCircle=function(){return new Circle(this.getPosition(),this.getRadius())};GameObject.prototype.getRenderCircle=function(){return new Circle(this.getPosition(),this.getRenderRadius())};GameObject.prototype.getColliderCircle=function(){return new Circle(this.getPosition(),this.getColliderRadius())};GameObject.prototype.getPosition=function(){return this.position};GameObject.prototype.getSpeed=function(){return this.speed};
GameObject.prototype.getAcceleration=function(){return this.accel};GameObject.prototype.copyPosition=function(){return this.getPosition().clone()};GameObject.prototype.copySpeed=function(){return this.getSpeed().clone()};GameObject.prototype.copyAcceleration=function(){return this.getAcceleration().clone()};GameObject.prototype.setPositionXY=function(d,b){var a=this.getPosition();a?a.setXY(d,b):this.position=new Vec2(d,b);return this};GameObject.prototype.setPosition=function(d){return this.setPositionXY(d.x,
d.y)};GameObject.prototype.setSpeedXY=function(d,b){var a=this.getSpeed();a?a.setXY(d,b):this.speed=new Vec2(d,b);return this};GameObject.prototype.setSpeed=function(d){return this.setSpeedXY(d.x,d.y)};GameObject.prototype.setAccelerationXY=function(d,b){var a=this.getAcceleration();a?a.setXY(d,b):this.accel=new Vec2(d,b);return this};GameObject.prototype.setAcceleration=function(d){return this.setAccelerationXY(d.x,d.y)};GameObject.prototype.moveXY=function(d,b){var a=this.getPosition();a&&this.setPosition(a.addXY(d,
b));return this};GameObject.prototype.move=function(d){return this.moveXY(d.x,d.y)};GameObject.prototype.accelerateXY=function(d,b){var a=this.getSpeed();a&&this.setSpeed(a.addXY(d,b));return this};GameObject.prototype.accelerate=function(d){return this.accelerateXY(d.x,d.y)};GameObject.prototype.kill=function(d){d.removeObject(this)};GameObject.prototype.onDeath=function(d){};GameObject.prototype.isOutOfMap=function(d,b,a){d=d.clone();exists(b)&&d.addMarginsXY(-b,exists(a)?-a:-b);if(b=this.getPosition()){if(d.contains(b))return 0;
d.addMargin(this.getRadius());a=0;b.x<d.left?a|=1:b.x>d.right&&(a|=4);b.y<d.top?a|=2:b.y>d.bottom&&(a|=8);return a}return 0};GameObject.prototype.maintainInRect=function(d,b,a){exists(b)&&(d=d.clone().addMarginsXY(-b,exists(a)?-a:-b));var e=this.getRect();b=this.getPosition();a=this.getSpeed();var g=e.left<d.left?d.left-e.left:e.right>d.right?d.right-e.right:0;d=e.top<d.top?d.top-e.top:e.bottom>d.bottom?d.bottom-e.bottom:0;g&&(b.x+=g,0<a.x&&0>g||0>a.x&&0<g)&&(a.x=0);d&&(b.y+=d,0<a.y&&0>d||0>a.y&&
0<d)&&(a.y=0)};GameObject.prototype.mustKeepInRect=function(){return!1};GameObject.prototype.toString=function(){return["object at",this.getPosition()].join(" ")};GameObject.Static=function(d){GameObject.call(this);this.setPosition(d?d:Vec2.ZERO)};classExtend(GameObject,GameObject.Static);GameObject.Cinetic=function(d){GameObject.Static.call(this,d);this.setSpeed(Vec2.ZERO)};classExtend(GameObject.Static,GameObject.Cinetic);GameObject.Dynamic=function(d){GameObject.Cinetic.call(this,d);this.setAcceleration(Vec2.ZERO)};
classExtend(GameObject.Cinetic,GameObject.Dynamic);return GameObject}();Game.objects.renderers=function(){var d={};d.Renderer=function(){var b=function(){};b.prototype.rotate=function(a){};b.prototype.grow=function(a){};b.prototype.render=function(a,b){};b.prototype.getRadius=function(){return 0};b.prototype.getRect=function(a){return Rect.createFromPoint(a)};return b}();d.Shaped=function(){parent=d.Renderer;ShapedRenderer=function(b,a){this.shape=b.clone();this.color=a};classExtend(parent,ShapedRenderer);ShapedRenderer.prototype.fill=!0;ShapedRenderer.prototype.stroke=
!1;ShapedRenderer.prototype.rotate=function(b){this.shape.rotate(b)};ShapedRenderer.prototype.grow=function(b){this.shape.grow(b)};ShapedRenderer.prototype.getColor=function(){return this.color};ShapedRenderer.prototype.setColor=function(b){this.color=b};ShapedRenderer.prototype.setShape=function(b){this.shape=b.clone()};ShapedRenderer.prototype.getShape=function(){return this.shape};ShapedRenderer.prototype.render=function(b,a){this.fill&&(a.fillStyle=this.color);this.stroke&&(a.strokeStyle=this.color);
this.shape.moveTo(b);this.shape.draw(a,this.fill,this.stroke)};ShapedRenderer.prototype.getRect=function(b){this.shape.moveTo(b);return this.shape.getRect()};ShapedRenderer.prototype.getRadius=function(){return this.shape.getRadius()};return ShapedRenderer}();return d}();Game.objects.colliders=function(){var d={},b=function(){var a=function(){};a.prototype.rotate=function(a){};a.prototype.grow=function(a){};a.prototype.getRadius=function(){return 0};a.prototype.getRect=function(a){return Rect.createFromPoint(a)};a.prototype.collidesWhenInside=function(a){return!1};a.prototype.prepareCollision=function(a){a.rect?a.rect.setRect(this.getRect(a.position)):a.rect=this.getRect(a.position)};a.prototype.finishCollision=function(){};a.prototype.collides=function(a,b){return!1};
return a}();d.Collider=b;d.Collider.prototype=b.prototype;b=function(){parent=d.Collider;var a=function(a){this.shape=a.clone()};classExtend(parent,a);a.prototype.rotate=function(a){this.shape.rotate(a)};a.prototype.grow=function(a){this.shape.grow(a)};a.prototype.getShape=function(){return this.shape};a.prototype.setShape=function(a){this.shape=a.clone()};a.prototype.collides=function(a,b){var d=b.collider;return b.collider.shape&&b.rect.overlap(a.rect)&&this.shape.intersect(d.shape)||this.collidesWhenInside(d)&&
d.shape.contains(a.position)||d.collidesWhenInside(this)&&this.shape.contains(b.position)};a.prototype.getRect=function(a){a&&this.shape.moveTo(a);return this.shape.getRect()};a.prototype.getRadius=function(){return this.shape.getRadius()};a.prototype.render=function(a,b){b.strokeStyle="#ff0000";this.getRect(a).draw(b,!1,!0);this.shape.draw(b,!1,!0)};return a}();d.Shaped=b;d.Shaped.prototype=b.prototype;return d}();Game.objects.properties={};
Game.objects.properties.Health={isDamageable:function(d){return exists(d.receiveDamages)},applyOnClass:function(d){d.prototype.receiveDamages=function(a,b,d){if(0>=this.health)return!1;this.health-=d;0>=this.health&&this.kill(a);return!0};d.prototype.heal=function(a){this.health+=a;!isNull(this.maxHealth)&&this.health>this.maxHealth&&(this.health=this.maxHealth)};d.prototype.setHealth=function(a){this.health=a};d.prototype.getHealth=function(){return this.health};var b=override(d,"getInformations",
function(){var a=b.call(this);a.push(["health :",this.health.toPrecision(4)].join(" "));return a});d.prototype.setMaxHealth=function(a){this.maxHealth=a};d.prototype.getMaxHealth=function(){return this.maxHealth};var a=override(d,"onDeath",function(b){a.call(b);isNull(this.maxHealth)||delete this.maxHealth;delete this.health})}};
Game.objects.properties.Energy={applyOnClass:function(d){d.prototype.useEnergy=function(a){if(this.getEnergy()<a)return!1;this.setEnergy(this.getEnergy()-a);return!0};d.prototype.setMaxEnergy=function(a){this.maxEnergy=a};d.prototype.setEnergy=function(a){this.energy=a};d.prototype.recoverEnergy=function(a){if(this.isEnergyFull())return!1;this.setEnergy(this.getEnergy()+a);this.isEnergyFull()&&this.setEnergy(this.getMaxEnergy());return!0};d.prototype.isEnergyFull=function(){return this.getEnergy()>=
this.getMaxEnergy()};d.prototype.setEnergyRecoverSpeed=function(a){this.energyRecoverSpeed=a};d.prototype.getMaxEnergy=function(){return this.maxEnergy};d.prototype.getEnergy=function(){return this.energy};d.prototype.getEnergyRecoverSpeed=function(){return this.energyRecoverSpeed};var b=override(d,"onFrame",function(a,d){b.call(this,a,d);var e=this.getEnergyRecoverSpeed();e&&!this.isEnergyFull()&&this.recoverEnergy(e*d)}),a=override(d,"getInformations",function(){var b=a.call(this);b.push(["energy :",
this.energy.toPrecision(4)].join(" "));return b}),e=override(d,"onDeath",function(a){e.call(a);delete this.energy;delete this.energyRecoverSpeed;delete this.maxEnergy})}};
Game.objects.properties.Homing={getSteeringForce:function(d,b,a,e,g){return Vec2.translation(d,g).normalize().mul(b).remove(e).clampMagnitude(0,a)},applyOnClass:function(d,b,a,e){var g=override(d,"onFrame",function(a,b){if(this.getTarget){var d=this.getTarget(a);if(d){d instanceof Game.objects.Object&&(d=d.getPosition());var e=this.getPosition(),m=Vec2.translation(e,d),n=m.magnitude(),p=this.getMaxSpeed(n),q=this.getSteerForce(p,n),m=m.mul(q/n);m.add(Game.objects.properties.Homing.getSteeringForce(e,
p,q,this.getSpeed(),d)).normalize().mul(q);this.setAcceleration(m);g.call(this,a,b);this.setSpeed(this.getSpeed().clampMagnitude(0,p))}else this.setAcceleration(Vec2.ZERO),g.call(this,a,b)}else g.call(this,a,b)});isNull(e)||(d.prototype.getTarget=e);isNull(b)?d.prototype.getMaxSpeed=function(a){return 200}:d.prototype.getMaxSpeed=function(a){return b};isNull(a)?d.prototype.getSteerForce=function(a,b){return 100}:d.prototype.getSteerForce=function(b,d){return a}},applyOnObject:function(d,b,a,e){var g=
d.onFrame;d.onFrame=function(d,h){var l=e(d);if(isNull(l))this.setAcceleration(Vec2.ZERO);else{console.log(l);l instanceof Game.objects.Object&&(l=l.getPosition());var k=this.getPosition(),m=Vec2.translation(k,l).normalize().mul(steer);m.add(Homing.getSteeringForce(k,this.getSpeed(),b,a,this.getSpeed(),l));this.setAcceleration(m)}g.call(this,d,h)}}};
Game.objects.properties.LifeTime={applyOnClass:function(d){var b=d.prototype.onFrame;d.prototype.onFrame=function(a,d){0>=this.lifeTime&&this.kill(a);b.call(this,a,d);this.lifeTime&&(this.lifeTime-=d)};var a=override(d,"getInformations",function(){if(isNull(this.lifeTime))return a.call(this);var b=a.call(this);b.push(["lifeTime :",this.lifeTime.toPrecision(4)].join(" "));return b}),e=override(d,"onDeath",function(a){e.call(a);delete this.lifeTime})},applyOnObject:function(d){var b=d.onFrame;d.onFrame=
function(a,d){0>=this.lifeTime&&this.kill(a);b.apply(this,arguments);exists(this.lifeTime)&&(this.lifeTime-=d)};d.onDeath=function(a){exists(this.lifeTime)&&delete this.LifeTime}}};
Game.objects.properties.Tag=function(){var d=function(b,a){return a.hasTag&&a.hasTag(b)};return{canHaveTag:function(b){return b.hasTag},hasTag:function(b,a){return b.hasTag&&b.hasTag(a)},getAllObjectsWithTag:function(b,a){return isNull(a)?b.getObjects(canHaveTag):b.getObjects(d.bind(void 0,a))},applyOnClass:function(b){b.prototype.addTag=function(a){this.tags||(this.tags=[]);this.tags.push(a)};b.prototype.hasTag=function(a){return!isNull(this.tags)&&-1!==this.tags.indexOf(a)};b.prototype.getTags=
function(){return this.tags};b.prototype.isTagged=function(){return this.tags?!0:!1};var a=override(b,"getInformations",function(){var b=this.getTags();return!isNull(b)&&0<b.length?(b=a.call(this),b.push(["tags :",this.tags.join(", ")].join(" ")),b):a.call(this)}),d=override(b,"onDeath",function(a){d.call(a);exists(this.tags)&&delete this.tags})}}}();Game.objects.Follower=function(){var d=Game.objects.Object.Dynamic,b=function(a,b,g,f){d.call(this,a);this.maxSpeed=exists(g)?g:100;this.steerForce=exists(f)?f:g;this.setTarget(b)};classExtend(d,b);Game.objects.properties.Homing.applyOnClass(b);b.prototype.onDeath=function(a){var b=a.getGameEventsListener();if(b)b.onObjectDestroyed(a,this)};b.prototype.getMaxSpeed=function(){return this.maxSpeed};b.prototype.getSteerForce=function(){return this.steerForce};b.prototype.getTarget=function(){return this.target};
b.prototype.setTarget=function(a){this.target=a};return b}();
Game.objects.Vehicle=function(){var d=Game.objects.Object.Static,b=function(a){d.call(this,a);this.setRotationFieldEnabled(!0);this.speed=0};classExtend(d,b);b.prototype.moveOnFrame=function(a,b){this.speed&&this.move(this.copySpeed().mul(b))};b.prototype.accelerateOnFrame=function(a,b){this.accel&&(this.speed+=this.accel*b)};b.prototype.getSpeed=function(){return 0===this.speed?Vec2.ZERO:new Vec2(Math.cos(this.radians)*this.speed,Math.sin(this.radians)*this.speed)};b.prototype.copySpeed=function(){return 0===
this.speed?new Vec2:this.getSpeed()};b.prototype.getAcceleration=function(){return 0===this.accel?Vec2.ZERO:new Vec2(Math.cos(this.radians)*this.accel,Math.sin(this.radians)*this.accel)};b.prototype.copyAcceleration=function(){return 0===this.accel?new Vec2:new Vec2(Math.cos(this.radians)*this.accel,Math.sin(this.radians)*this.accel)};b.prototype.accelerate=function(a){this.speed+=a};b.prototype.setSpeed=function(a){this.speed=a};b.prototype.setAcceleration=function(a){this.accel=a};return b}();Game.objects.particles=function(){var d={};d.Particle=function(){var b=Game.objects.Object,a=function(a,d,e){b.call(this);this.lifeTime=a;this.shape=d;this.color=e};classExtend(b,a);Game.objects.properties.LifeTime.applyOnClass(a);var d=override(a,"onFrame",function(a,b){d.call(this,a,b);this.isOutOfMap(a.getMap().getVisibleRect(),0,0)&&(this.lifeTime=0)});a.prototype.render=function(a){a.fillStyle=this.color;this.shape.draw(a,!0,!1)};a.prototype.getPosition=function(){return this.shape.center};a.prototype.copyPosition=
function(){return this.shape.center.clone()};a.prototype.rotate=function(a){this.shape.rotate(a)};a.prototype.grow=function(a){this.shape.grow(a)};a.prototype.canCollide=function(a){return!1};a.prototype.collides=function(a){return!1};a.prototype.renderLayer=Game.Map.LAYER_PARTCILES;a.prototype.collisionLayers=[Game.objects.Object.NO_COLLISION_LAYER];a.prototype.prepareCollision=function(){console.stack("error : the method 'prepareCollision()' should not be called for a particle.")};delete a.prototype.renderMouseOver;
return a}();d.Stroked=function(){var b=d.Particle;StrokedParticle=function(a,d,g){b.call(this,a,d,g)};classExtend(b,StrokedParticle);StrokedParticle.prototype.constructor=b.prototype.constructor;StrokedParticle.prototype.render=function(a){a.strokeStyle=this.color;this.shape.draw(a,!1,!0)};return StrokedParticle}();d.Emitor=function(){var b=Game.objects.Object.Static,a=function(a,e){b.call(this);this.rate=a;this.emited=0;e&&(this.max=e);this.particleGenerator=function(a,b,e,f){return new d.Particle(a,
new Circle(b,5),"#"+Math.round(16777215*Math.random()).toString(16))};this.emitedParticles=[]};classExtend(b,a);a.prototype.minLifeTime=.75;a.prototype.maxLifeTime=1.5;a.prototype.minAngle=0;a.prototype.maxAngle=2*Math.PI;a.prototype.minSpeed=300;a.prototype.maxSpeed=400;a.prototype.speedDampFactor=2.5;a.prototype.reduceSizeFactor=1.2;a.prototype.emitDistance=0;a.prototype.particleGenerator=function(a,b,e,g){return new d.Particle(a,new Circle(b,5),"#"+Math.round(16777215*Math.random()).toString(16))};
a.prototype.restart=function(){this.emited=0};a.prototype.stop=function(){this.emited=-1};a.prototype.isRunning=function(){return 0<=this.emited};a.prototype.setAngles=function(a,b){this.setMinAngle(a);this.setMaxAngle(isNull(b)?a:b)};a.prototype.setMinAngle=function(a){this.minAngle=a};a.prototype.setMaxAngle=function(a){this.maxAngle=a};a.prototype.getMinAngle=function(){return this.minAngle};a.prototype.getMaxAngle=function(){return this.maxAngle};a.prototype.setEmitDistance=function(a){this.emitDistance=
a};a.prototype.getEmitDistance=function(){return this.emitDistance};a.prototype.setEmitRate=function(a){this.rate=a};a.prototype.getEmitRate=function(){return this.rate};a.prototype.setLifeTime=function(a,b){this.setMinLifeTime(a);this.setMaxLifeTime(b?b>a?b:a:a)};a.prototype.setMinLifeTime=function(a){this.minLifeTime=a};a.prototype.setMaxLifeTime=function(a){this.maxLifeTime=a};a.prototype.getMinLifeTime=function(){return this.minLifeTime};a.prototype.getMaxLifeTime=function(){return this.maxLifeTime};
a.prototype.setSpeedDampFactor=function(a){this.speedDampFactor=a};a.prototype.getSpeedDampFactor=function(){return this.speedDampFactor};a.prototype.setSizeReduceFactor=function(a){this.reduceSizeFactor=a};a.prototype.getSizeReduceFactor=function(){return this.reduceSizeFactor};var e=override(a,"rotate",function(a){e.call(this,a);this.minAngle+=a;this.maxAngle+=a});a.prototype.getParticleGenerator=function(){return this.particleGenerator};a.prototype.setParticleGenerator=function(a){this.particleGenerator=
a};a.prototype.collisionLayers=[Game.objects.Object.NO_COLLISION_LAYER];a.prototype.renderLayer=Game.Map.LAYER_NONE;a.prototype.canCollide=function(a){return!1};var g=override(a,"onFrame",function(a,b){g.call(this,a,b);var d=this.emitedParticles.length,e=Math.max(0,1-this.speedDampFactor*b),m=Math.max(0,1-this.reduceSizeFactor*b);if(0<d)for(;d--;)0>=this.emitedParticles[d].lifeTime?this.emitedParticles.splice(d,1):(this.emitedParticles[d].speed&&1!==e&&this.emitedParticles[d].speed.mul(e),1!==m&&
this.emitedParticles[d].grow(m));this.max&&0===this.emitedParticles.length&&this.emited>=this.max&&this.kill(a);if(-1<this.emited&&(!this.max||this.emited<this.max)&&(e=this.emited+b*this.rate,this.max&&e>this.max&&(e=this.max),d=Math.floor(e-Math.floor(this.emited)),this.emited=e,0<d))for(;d--;){var n=Math.random()*(this.maxLifeTime-this.minLifeTime)+this.minLifeTime,e=Math.round(Math.random()*(this.maxSpeed-this.minSpeed)+this.minSpeed);0<e?(m=Math.random()*(this.maxAngle-this.minAngle)+this.minAngle,
n=this.particleGenerator(n,this.position,m,e),this.emitDistance&&n.move(Vec2.createFromRadians(m).mul(this.emitDistance)),n.speed=new Vec2(Math.cos(m)*e,Math.sin(m)*e)):n=this.particleGenerator(n,this.position,0,0);this.emitedParticles.push(n);a.addObject(n)}if(this.particlePositionRelative&&this.speed&&!this.speed.isZero()&&(e=this.speed.clone().mul(b),d=this.emitedParticles.length,0<d))for(;d--;)this.emitedParticles[d].shape.move(e)});return a}();d.Explosion=function(){var b=d.Emitor,a=function(a){b.call(this,
1E3*a,a)};classExtend(b,a);a.prototype.minLifeTime=.1;a.prototype.maxLifeTime=.5;a.prototype.minSpeed=500;a.prototype.maxSpeed=1500;a.prototype.speedDampFactor=2;a.prototype.reduceSizeFactor=3;return a}();d.TraceDrawer=function(){TraceDrawer=function(b,a){this.lifeTime=b;this.color=a};TraceDrawer.prototype.applyOnObject=function(b,a){var d=a.setPositionXY,g=this;a.setPositionXY=function(f,h){var l=a.copyPosition();d.call(this,f,h);var k=a.getPosition();if(!l.equals(k))g.onMove(b,l,k)}};TraceDrawer.applyOnClass=
function(b){var a=b.prototype.moveOnFrame;b.prototype.moveOnFrame=function(b,d){if(this.traceDrawer){var f=this.copyPosition();a.call(this,b,d);var h=this.getPosition();if(!f.equals(h))this.traceDrawer.onMove(b,f,h)}else a.call(this,b,d)}};TraceDrawer.prototype.onMove=function(b,a,d){a=this.getParticlesForTranslation(a,d);if(a.length)for(d=0;d<a.length;d++)b.addObject(a[d]);else b.addObject(a)};TraceDrawer.prototype.getParticlesForTranslation=function(b,a){return new d.Stroked(this.lifeTime,new Line(b,
a),this.color)};return TraceDrawer}();return d}();Game.objects.bullets=function(){var d={},b=function(){var a=Game.objects.Object.Static,b=function(b,d,e,g){a.call(this,d);exists(e)&&(this.speed=e.clone());this.damages=b;isNull(g)||(this.lifeTime=g)};classExtend(a,b);Game.objects.particles.TraceDrawer.applyOnClass(b);Game.objects.properties.LifeTime.applyOnClass(b);b.defaultTraceDrawer=new TraceDrawer(.05,"#FF0000");b.defaultShape=new Polygon(Vec2.createVec2Array([-10,2,5,2,7,1,8,0,7,1,5,-2,-10,-2]));b.prototype.setLauncher=function(a){this.launcher=
a};b.prototype.getLauncher=function(){return this.launcher};b.prototype.getDamages=function(){return this.damages};b.prototype.setDamages=function(a){this.damages=a};b.prototype.onDeath=function(a){this.explosion&&(this.explosion.position.set(this.position),a.addObject(this.explosion))};var d=override(b,"moveOnFrame",function(a,b){d.call(this,a,b);this.isOutOfMap(a.gameMap.getVisibleRect())&&(delete this.explosion,this.kill(a))});b.COLLISION_LAYER=2;b.prototype.collisionLayers=[b.COLLISION_LAYER];
b.prototype.onCollision=function(a,b){this.launcher!=b&&0!==this.damages&&(b.receiveDamages&&b.receiveDamages(a,this,this.damages)&&(this.damages=0),this.kill(a))};b.createBullet=function(a,d,g,f,n){a=new b(a,d,g);f=f.clone();f.rotate(g.getAngle());a.renderer=new GameObjectRenderer.Shaped(f.clone(),n);a.collider=new b.Collider(f);a.explosion=new ParticleEmitor.Explosion(20);a.traceDrawer=b.defaultTraceDrawer;return a};b.prototype.renderLayer=Game.Map.LAYER_OBJ3;getInfo=override(b,"getInformations",
function(){var a=getInfo.call(this);a.push(["damages : ",this.damages.toString()].join(""));return a});var f=override(b,"renderMouseOver",function(a,b,d,e){!d.running&&e&&f.call(this,a,b,d,e)});return b}();d.Bullet=b;d.Bullet.prototype=b.prototype;b=function(){var a=Game.objects.colliders.Shaped,b=function(b){a.call(this,b)};classExtend(a,b);b.prototype.collidesWhenInside=function(a){return!0};return b}();d.Collider=b;d.Collider.prototype=b.prototype;b=function(){var a=d.Bullet,b=function(b,e,h,l,
k){a.call(this,b,e,Vec2.ZERO,h);b=new Ray(e,k);this.renderer=new Game.objects.renderers.Shaped(b,l);this.collider=new d.Collider(b)};classExtend(a,b);return b}();d.Laser=b;d.Laser.prototype=b.prototype;b=function(){var a=d.Bullet,b=Game.objects.properties,g=function(b,d,e,g,f,h){a.call(this,b,d,e,h);this.maxSpeed=e.magnitude();this.steerForce=g;this.maxAngle=f;this.setRotationFieldEnabled(!0)};classExtend(a,g);b.Homing.applyOnClass(g);g.prototype.getMaxSpeed=function(a){return this.maxSpeed*(1-Math.sqrt(this.maxSpeed/
(150*a)))};g.prototype.getSteerForce=function(a,b){return a/Math.pow(b,1.2)*this.steerForce};var f=Game.objects.properties.Health.isDamageable,h=function(a,b){if(b.isInLayer(-1)||!f(b))return!1;for(var d=a.length,e=0;e<d;e++)if(b.isInLayer(a[e]))return!0;return!1};g.prototype.getTarget=function(a){var b,d=this.maxAngle,e=this.getPosition();a=a.getObjects(h.bind(void 0,this.collisionLayers));var g=a.length;if(0<g)for(;g--;)a[g]!==this.launcher&&(angle=(Vec2.translation(e,a[g].getPosition()).getAngle()-
this.radians)%(2*Math.PI),angle>Math.PI&&(angle=2*Math.PI-angle),angle<d&&(d=angle,b=a[g]));return isNull(b)?null:b.getPosition()};var l=override(g,"onFrame",function(a,b){l.call(this,a,b);this.setRadians(this.getSpeed().getAngle())});return g}();d.Homing=b;d.Homing.prototype=b.prototype;return d}();Game.objects.interactives=function(){var d={};d.obstacles=function(){var b={};b.Obstacle=function(){var a=Game.objects.Object.Static,b=function(b){a.call(this,b)};classExtend(a,b);b.prototype.onCollision=function(a,b){};b.prototype.repulse=function(a,b){a.move(b);var d=a.copySpeed(),e=b.getAngle();d.rotate(-e);d.x=0;d.rotate(e);a.setSpeed(d)};b.COLLISION_LAYER=0;b.prototype.collisionLayers=[b.COLLISION_LAYER];b.prototype.renderLayer=Game.Map.OBJ1;return b}();b.Rectangular=function(){var a=b.Obstacle,
d=function(b){a.call(this,b)};classExtend(a,d);d.prototype.disableBelow=function(a){this.enableBelowCross=a};d.prototype.disableAbove=function(a){this.enableAboveCross=a};d.prototype.disableLeft=function(a){this.enableLeftCross=a};d.prototype.disableRight=function(a){this.enableRightCross=a};d.prototype.onCollision=function(a,b){var d=this.getRadians(),e,k,m=b.getPosition();e=this.getPosition();var n=b.getSpeed();0!==d&&(this.getCollider().rotate(-d),b.getCollider().rotate(-d),m=Vec2.translation(e,
m).rotate(-d).add(e),n=n.clone().rotate(-d));e=b.getCollider().getRect(m);k=this.getCollider().getRect();var p=Vec2.zero();!this.enableAboveCross&&k.below(m)&&-.01<=n.y?p.y=k.top-e.bottom:!this.enableBelowCross&&k.above(m)&&.01>=n.y&&(p.y=k.bottom-e.top);!this.enableRightCross&&k.onLeftOf(m)&&.01>=n.x?p.x=k.right-e.left:!this.enableLeftCross&&k.onRightOf(m)&&-.01<=n.x&&(p.x=k.left-e.right);0!==d&&(this.getCollider().rotate(d),b.getCollider().rotate(d),p.rotate(d));p.isZero()||this.repulse(b,p)};return d}();
b.Circular=function(){var a=b.Obstacle,d=function(b){a.call(this,b)};classExtend(a,d);d.prototype.onCollision=function(a,b){var d=this.getPosition(),e=b.getPosition(),k=Vec2.translation(d,e),m=k.getAngle(),n=d.x+this.getCollider().getRadius(),p=b.getSpeed();0!==m&&(b.getCollider().rotate(-m),e=k.rotate(-m).add(d),p=p.clone().rotate(-m));0>=p.x?(d=b.getCollider().getRect(e),n=new Vec2(n-d.left,0),0!==m&&(b.getCollider().rotate(m),n.rotate(m)),n.isZero()||this.repulse(b,n)):0!==m&&b.getCollider().rotate(m)};
return d}();b.properties={Bumper:{applyOnObstacle:function(a,b){var d=a.repulse;a.repulse=function(a,b){var e=a.copySpeed();d.call(this,a,b);var k=b.getAngle();e.rotate(-k);e.x=-e.x*this.getBumperStrength();40<Math.abs(e.x)&&(e.rotate(k),a.setSpeed(e))};a.setBumperStrength=function(a){this.bumperStrength=a};a.getBumperStrength=function(){return this.bumperStrength};exists(b)&&a.setBumperStrength(b)},applyOnObstacleClass:function(a,b){var d=override(a,"repulse",function(a,b){var e=a.copySpeed();d.call(this,
a,b);var k=b.getAngle();e.rotate(-k);e.x=-e.x*this.getBumperStrength();40<Math.abs(e.x)&&(e.rotate(k),a.setSpeed(e))});a.prototype.setBumperStrength=function(a){this.bumperStrength=a};a.prototype.getBumperStrength=function(){return this.bumperStrength};exists(b)&&(a.prototype.bumperStrength=b)}}};return b}();return d}();Game.weapons=function(){var d={};d.Weapon=function(){var b=function(a,b){this.damages=a;isNull(b)||this.setOwner(b)};b.prototype.use=function(a,b,d){};b.prototype.setOwner=function(a){this.owner=a};b.prototype.getOwner=function(){return this.owner};b.prototype.getDamages=function(){return this.damages};b.prototype.setDamages=function(a){this.damages=a};b.prototype.onDeath=function(){delete this.damages;this.owner&&delete this.owner};b.prototype.clone=function(){return new b(this.damages,null)};b.applyOnClass=
function(a){a.prototype.setWeapon=function(a){isNull(a)?exists(this.weapon)&&delete this.weapon:this.weapon=a};a.prototype.getWeapon=function(){return this.weapon};a.prototype.useWeapon=function(a){isNull(this.weapon)||this.weapon.use(a,this.getPosition(),this.getRadians())};var b=override(a,"onDeath",function(a){exists(this.weapon)&&(this.weapon.onDeath(),delete this.weapon);b.call(this,a)})};b.applyOnObject=function(a){a.setWeapon=function(a){isNull(a)?exists(this.weapon)&&delete this.weapon:this.weapon=
a};a.getWeapon=function(){return this.weapon};a.useWeapon=function(a){exists(this.weapon)&&this.weapon.use(a,this.getPosition(),this.gertRadians())};var b=a.onDeath;a.onDeath=function(a){exists(this.weapon)&&(this.weapon.onDeath(),delete this.weapon);b.call(this,a)}};return b}();d.Gun=function(){var b=d.Weapon,a=function(a,d,e){b.call(this,a,e);this.bulletGenerator=d};classExtend(b,a);a.prototype.createBullet=function(a,b){var d=this.bulletGenerator(this.getDamages(),a,b),e=this.getOwner();e&&d.setLauncher(e);
return d};a.prototype.use=function(a,b,d){a.addObject(this.createBullet(b,d))};a.prototype.clone=function(){return new a(this.damages,this.bulletGenerator)};a.defaultBulletValues={renderShape:Game.objects.bullets.Bullet.defaultShape,colliderShape:Game.objects.bullets.Bullet.defaultShape,color:"#0F0",speed:300,spawnDistance:5,explosionSize:0};a.createBulletGenerator=function(b){var d=createProperties(a.defaultBulletValues,b);return function(a,b,e){var g=Vec2.createFromRadians(e).mul(d.speed);b=Vec2.createFromRadians(e).mul(d.spawnDistance).add(b);
a=new Game.objects.bullets.Bullet(a,b,g,d.lifeTime);a.renderer=new Game.objects.renderers.Shaped(d.renderShape,d.color);a.collider=new Game.objects.colliders.Shaped(d.colliderShape);e&&a.rotate(e);d.trace&&(a.traceDrawer=d.trace);d.explosionSize&&(a.explosion=new Game.objects.particles.Explosion(d.explosionSize),d.particleGenerator&&a.explosion.setParticleGenerator(d.particleGenerator));return a}};a.defaultHomingBulletValues=createProperties(a.defaultBulletValues);a.defaultHomingBulletValues.maxAngle=
Math.PI/8;a.createHomingBulletGenerator=function(b){var d=createProperties(a.defaultHomingBulletValues,b);exists(d.steerForce)||(d.steerForce=Math.pow(d.speed,1.6)/(10/Math.log(1+d.maxAngle)));return function(a,b,e){var g=Vec2.createFromRadians(e).mul(d.speed);a=new Game.objects.bullets.Homing(a,b,g,d.steerForce,d.maxAngle,d.lifeTime);a.renderer=new Game.objects.renderers.Shaped(d.renderShape,d.color);a.collider=new Game.objects.colliders.Shaped(d.colliderShape);e&&a.rotate(e);isNull(d.trace)||(a.traceDrawer=
d.trace);isNull(d.explosionSize)||(a.explosion=new Game.objects.particles.Explosion(d.explosionSize));return a}};a.createLaserBulletGenerator=function(a,b,d){var e;e=exists(d)?new Line(Vec2.ZERO,new Vec2(d,0)):new Ray(Vec2.ZERO,0);return function(b,f,n){d&&(f=Vec2.createFromRadians(n).mul(d/2).add(f));b=new Game.objects.bullets.Bullet(b,f,Vec2.ZERO,.01);b.renderer=new Game.objects.renderers.Shaped(e,a);b.renderer.fill=!1;b.renderer.stroke=!0;b.collider=new Game.objects.colliders.Shaped(e);b.rotate(n);
return b}};var e=override(a,"onDeath",function(){e.call(this);delete this.bulletGenerator});return a}();return d}();Game.Physics=function(){var d={G:6.67384E-11,friction:2,Mass:{applyOnClass:function(b,a){b.prototype.mass=exists(a)?a:0;b.prototype.setMass=function(a){this.mass=a};b.prototype.getMass=function(){return this.mass};b.prototype.applyForce=function(a){a=(new Vec2(a)).mul(this.getMass());a.add(this.copyAcceleration());this.setAcceleration(a)}},applyOnObject:function(b,a){b.setMass=function(a){this.mass=a};b.getMass=function(){return this.mass};b.applyForce=function(a){a=(new Vec2(a)).mul(this.getMass());
a.add(this.copyAcceleration());this.setAcceleration(a)}},hasMass:function(b){return exists(b.getMass)},elasticCollision:function(b,a){var d=this.hasMass(b)?b.getMass():1,g=this.hasMass(a)?a.getMass():1,f=b.getPosition(),h=b.getSpeed(),l=a.getPosition(),k=a.getSpeed(),f=Vec2.translation(f,l).mul(Vec2.distance(h,k)/(d+g));b.setSpeed(f.clone().mul(g));a.setSpeed(f.mul(d))}},applyForce:function(b,a){b.setAcceleration(b.getAcceleration().add(a))},applyGravity:function(b,a){d.applyForce(b,a.clone().mul(9.81))},
applyFriction:function(b){var a=b.getSpeed();a&&!a.isZero()&&d.applyForce(b,a.clone().mul(friction))},applySpaceGravity:function(b,a){var e=a.mass|1,g=b.mass|1,f=Vec2.translation(b,a),e=d.G*e*g/f.squareMagnitude();d.applyForce(b,f.normalize().mul(e))}};return d}();Game.hud={};
Game.hud.Hud=function(){var d=function(b){this.views=[];this.currentView=null;b&&(this.context2d=b.getContext("2d"),b.style.background="#00000000");this.alpha=.5;this.active=!0};d.prototype.addView=function(b){this.views.push(b)};d.prototype.removeView=function(b){b=this.views.indexOf(b);0<=b&&this.views.splice(b,1)};d.prototype.setAlpha=function(b){this.alpha=b};d.prototype.getAlpha=function(){return this.alpha};d.prototype.onRectUpdate=function(b){for(var a=0;a<view.length;a++)v.onRectUpdate(b)};d.prototype.updateRect=
function(b){requestAnimationFrame(this.render.bind(this,this.context2d,b?b:new Rect(0,0,this.context2d.canvas.width,this.context2d.canvas.height)))};d.prototype.getChildRect=function(b){return b.getRect()};d.prototype.getContext=function(){return this.context2d};d.prototype.render=function(b,a){var d=this.views.length,g=0;for(b.globalAlpha=this.getAlpha();g<d;)this.views[g++].render(b,a)};d.prototype.mouseButton=function(b,a){return!isNull(this.currentView)&&this.currentView.onTouchEvent({position:position,
description:a?Game.hud.views.EVENT_DESC.DOWN:Game.hud.views.EVENT_DESC.UP,button:b})};d.prototype.mouseMove=function(b){if(this.active){var a,d,g={description:Game.hud.views.EVENT_DESC.MOVE,position:Vec2.zero()};if(this.currentView){if(this.currentView.hasFocus()&&(g.position.set(b).addXY(-a.left,-a.top),g.onTouchEvent(g)))return;this.currentView=null}var f=this.views.length,h;if(0<f)for(;f--;)if(d=this.views[f],!(d.state&Game.hud.views.STATE.INACTIVE)&&(a=d.getRect(),d==this.currentView||a.contains(b)))if(g.position.set(b).addXY(-a.left,
-a.top),h||d==this.currentView&&!a.contains(b)||(h=d),d.onTouchEvent(g)){g.description=Game.hud.views.EVENT_DESC.EXIT;if(this.currentView)this.currentView.onTouchEvent(g);this.currentView=d;break}!this.currentView&&h&&(this.currentView=h)}};d.prototype.click=function(b,a){return!isNull(this.currentView)&&this.currentView.onTouchEvent({position:b,description:Game.hud.views.EVENT_DESC.CLICK,button:a})};return d}();Game.hud.views={STATE:{INACTIVE:1,NONE:2,OVERED:4,PRESSED:8},EVENT_DESC:{MOVE:0,ENTER:1,EXIT:2,SCROLL:3,DOWN:4,UP:5,CLICK:6},TouchEvent:function(d,b,a,e){this.position=d;this.description=b;b==Game.hud.views.EVENT_DESC.SCROLL&&(this.scroll=a);b>=Game.hud.views.EVENT_DESC.DOWN&&(this.btn=a,this.pressed=e)}};
Game.hud.views.View=function(){var d=function(a){this.parentView=a};d.prototype.state=Game.hud.views.STATE.INACTIVE;d.prototype.render=function(a,b){};d.prototype.getState=function(){return this.state};d.prototype.setState=function(a){this.state=a};d.prototype.getParentView=function(){return this.parentView};d.prototype.setParentView=function(a){this.parentView=a};d.prototype.onRectUpdate=function(a){};d.prototype.getPosition=function(){return new Vec2(Vec2.ZERO)};d.prototype.containsPoint=function(a){return!1};
d.prototype.getRect=function(){return Rect.createFromPoint(this.getPosition())};d.prototype.onClick=function(a,b){console.log("onClick");return!1};var b=Game.hud.views.EVENT_DESC;d.prototype.onTouchEvent=function(a){console.log("touch event : "+a.description);switch(a.description){case b.DOWN:return this.state|=views.STATE.PRESSED,!0;case b.UP:return this.state&=views.STATE.OVERED,!1;case b.CLICK:return this.onClick(a.position,a.btn);case b.MOVE:return this.hasFocus();case b.ENTER:return this.state=
views.STATE.OVERED,this.hasFocus();case b.EXIT:return this.state=views.STATE.NONE,this.hasFocus()}};d.update=function(){var a=this.getParentView();isNull(a)||a.updateRect(a.getChildRect(this))};d.prototype.isOvered=function(){return 0!==(this.state&Game.hud.views.STATE.OVERED)};d.prototype.isPressed=function(){return 0!==(this.state&Game.hud.views.STATE.PRESSED)};d.prototype.hasFocus=function(){return this.isPressed()};d.prototype.toString=function(){return"hud.views.View"};return d}();
Game.hud.views.TextView=function(){var d=Game.hud.views.View,b=function(a,b,g,f){d.call(this,a);this.setText(b);isNull(g)||this.setRect(g);this.setFontSize(12);this.setFont("Verdana");isNull(f)||this.setTextColor(f)};classExtend(d,b);b.prototype.setText=function(a){this.text=a};b.prototype.getText=function(){return this.text};b.prototype.setFontSize=function(a){this.fontSize=a};b.prototype.getFontSize=function(){return this.fontSize};b.prototype.setFont=function(a){this.font=a};b.prototype.getFont=
function(){return this.font};b.prototype.setTextColor=function(a){this.textColor=a};b.prototype.getTextColor=function(){return this.textColor};b.prototype.setRect=function(){this.rect=rect};b.prototype.getRect=function(){return this.rect};b.prototype.getPosition=function(){return getRect().center()};b.prototype.containsPoint=function(a){return this.getRect().contains(a)};b.prototype.render=function(a,b){var d=this.getRect();isNull(d)&&(d=b);this.getState()&Game.hud.views.STATE.OVERED&&(a.lineWidth*=
2,a.strokeStyle="#fff",d.draw(a,this.fill,!0),a.lineWidth/=2);a.strokeStyle=this.getTextColor();var f=this.getFontSize();a.font=[f,"px ",this.getFont()].concat();a.wrapText(this.getText(),d,1.25*f,Gravity.CENTER,!1,!0)};return b}();
Game.hud.views.Button=function(){var d=Game.hud.views.TextView,b=function(a,b,f,h,l){isNull(l)&&(l="black");d.call(this,a,h,void 0,l);this.setShape(b);this.setShapeColor(f);this.stroke=!0;this.fill=!1;this.setGravity(Gravity.LEFT|Gravity.TOP)};classExtend(d,b);b.prototype.state=Game.hud.views.STATE.ACTIVE;b.prototype.setShape=function(a){this.shape=a.clone()};b.prototype.getShape=function(){return this.shape};b.prototype.getPosition=function(){return this.getShape().center};b.prototype.getRect=function(){return this.getShape().getRect()};
b.prototype.setGravity=function(a){this.gravity=a};b.prototype.getGravity=function(){return isNull(this.gravity)?Gravity.LEFT|Gravity.TOP:gravity};b.prototype.onClick=function(){return!0};b.prototype.getShapeColor=function(){return this.shapeColor};b.prototype.setShapeColor=function(a){this.shapeColor=a};b.prototype.setStroke=function(a){this.stroke=a};b.prototype.setFill=function(a){this.fill=a};b.prototype.containsPoint=function(a){return this.getShape().contains(a)};var a=override(b,"render",function(b,
d){b.fillStyle=b.strokeStyle=this.getShapeColor();this.getState()&Game.hud.views.STATE.OVERED?(b.lineWidth*=2,b.strokeStyle="#fff",this.getShape().draw(b,this.fill,!0),b.lineWidth/=2):this.getShape().draw(b,this.fill,this.stroke);a.call(this,b)});return b}();
Game.hud.views.ProgressBar=function(){var d=Game.hud.views.View,b=function(a,b,g,f,h){d.call(this,a);this.needFillUpdate=this.needStrokeUpdate=!0;this.setWidth(b);this.setHeight(g);this.setMax(f);this.setValue(h);this.setMargins(0,0);this.setGravity(Gravity.LEFT|Gravity.TOP);this.setColor("#f00")};classExtend(d,b);b.prototype.createShape=function(a,b){var d=a?this.getWidth():this.getWidth()/this.getMax()*this.getValue(),f=this.getHeight(),h=this.getGravity(),l=NaN,k=NaN,m=NaN,n=NaN;(h&Gravity.RIGHT)===
Gravity.RIGHT?n=b.right-this.getMarginX():l=(h&Gravity.LEFT)===Gravity.LEFT||(h&Gravity.CENTER)!==Gravity.CENTER?b.left+this.getMarginX():b.left+(canvasrect.width()-d)/2;(h&Gravity.BOTTTOM)===Gravity.BOTTOM?m=b.bottom-this.getMarginY():k=(h&Gravity.TOP)===Gravity.TOP||(h&Gravity.CENTER)!==Gravity.CENTER?b.top+this.getMarginY():b.top+(b.height()-f)/2;isNaN(l)?l=n-d:isNaN(n)&&(n=l+d);isNaN(k)?k=m-f:isNaN(m)&&(m=k+f);return(new Rect(l,k,n,m)).getShape()};b.prototype.setGravity=function(a){this.gravity=
a;this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getGravity=function(){return this.gravity};b.prototype.getStrokeShape=function(a){this.needStrokeUpdate&&!isNull(a)&&(this.strokeShape=this.createShape(!0,a),this.needStrokeUpdate=!1);return this.strokeShape};b.prototype.getFillShape=function(a){this.needFillUpdate&&!isNull(a)&&(this.fillShape=this.createShape(!1,a),this.needFillUpdate=!1);return this.fillShape};b.prototype.setWidth=function(a){this.width=a;this.needStrokeUpdate=this.needFillUpdate=
!0};b.prototype.getWidth=function(){return this.width};b.prototype.setHeight=function(a){this.height=a;this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getHeight=function(){return this.height};b.prototype.setMax=function(a){this.max=a;this.needFillUpdate=this.needStrokeUpdate=!0};b.prototype.getMax=function(){return this.max};b.prototype.setValue=function(a){this.value=a;this.needFillUpdate=!0};b.prototype.getValue=function(){return this.value};b.prototype.setMargins=function(a,b){typeof a==
TYPE_NUMBER&&(this.marginX=a);typeof b==TYPE_NUMBER&&(this.marginY=b);this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getMarginX=function(){return this.marginX};b.prototype.getMarginY=function(){return this.marginY};b.prototype.setColor=function(a){this.color=a};b.prototype.getColor=function(){return this.color};b.prototype.onRectUpdate=function(a){this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getPosition=function(){return this.getStrokeShape().center};b.prototype.getRect=function(){return this.getStrokeShape().getRect()};
b.prototype.containsPoint=function(a){var b=this.getStrokeShape();return!isNull(b)&&b.contains(a)};b.prototype.render=function(a,b){var d=this.getStrokeShape(b),f=this.getFillShape(b),h=this.getColor();a.fillStyle=h;f.draw(a,!0,!1);this.getState()&Game.hud.views.STATE.OVERED?(a.lineWidth*=2,a.strokeStyle="#fff",d.draw(a,!1,!0),a.lineWidth/=2):(a.strokeStyle=h,d.draw(a,!1,!0))};return b}();
Game.hud.views.SegmentedProgressBar=function(){var d=Game.hud.views.ProgressBar,b=function(a,b,g,f,h,l,k){d.call(this,a,b,g,f,h);this.setSegments(l);this.setInclination(k)};classExtend(d,b);b.prototype.setSegments=function(a){this.segments=a;this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getSegments=function(){return this.segments};b.prototype.setInclination=function(a){this.inclination=a;this.needStrokeUpdate=this.needFillUpdate=!0};b.prototype.getInclination=function(){return this.inclination};
b.prototype.createShape=function(a,b){var d=this.getHeight(),f=this.getInclination(),h=this.getSegments(),l=this.getWidth()-f*d,k=l/h,m=d/h,n=m*f,d=[new Vec2(f*d,0),new Vec2(0,d)],p;if(a)for(f=1;f<h+1;f++)p=2*f,d.push(new Vec2(d[p-1].x+k,d[p-1].y)),d.push(new Vec2(d[p].x+n,d[p].y-m));else for(var q=this.getValue(),r=this.getMax(),f=1;f<h+1;f++)p=2*f,q>r*f/h?(d.push(new Vec2(d[p-1].x+k,d[p-1].y)),d.push(new Vec2(d[p].x+n,d[p].y-m))):(n=(q-r*(f-1)/h)*l/r,d.push(new Vec2(d[p-1].x+n,d[p-1].y)),d.push(new Vec2(d[0].x+
q/r*l,0)));h=new Polygon(d);h.moveXY(b.left+this.getMarginX(),b.top+this.getMarginY());l=this.getGravity();l&Gravity.BOTTOM&&h.mirrorVertically((b.top+b.bottom)/2);l&Gravity.RIGHT&&h.mirrorHorizontally((b.left+b.right)/2);return h};return b}();Game.hud.views.Layout=function(){var d=function(){this.children=[];this.currentView=null;this.rect=new Rect(0,0,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER);this.setState(Game.hud.views.STATE.NONE)};d.prototype.addView=function(a,b){a.layoutParams=b;this.addView(a)};d.prototype.addView=function(a){a.layoutRule||(a.layoutParams=this.getDefaultLayoutParams());this.children.push(a)};d.prototype.getDefaultLayoutParams=function(){return{}};d.prototype.onTouchEvent=function(a){if(a.description<=Game.hud.views.EVENT_DESC.EXIT)return this.mouseMove(a);
if(!isNull(currentView))return currentView.onTouchEvent(a)};d.prototype.updateRect=function(a){this.getParentView().updateRect(a)};d.mouseMove=function(a){for(var b,d,f=!1,h=this.views.length,l=a.position;h--;)if(d=this.views[h],!(f&&d!=currentView||d.state&Game.hud.views.STATE.INACTIVE)){b=d.getRect();a.position.set(l).addXY(-b.left,-b.top);if(f&&d==currentView){currentView.onTouchEvent(a);break}if(d.onTouchEvent(a)){if(isNull(currentView)){currentView=d;break}f=!0;a.description=Game.hud.views.EVENT_DESC.EXIT}}};
var b=override(d,"render",function(a){b.call(this,a);a.save();a.translate(this.rect.left,this.rect.top);var d=this.getRect();a.rect(0,0,d.width(),d.height());a.clip();for(var d=this.children.length,g,f,h=0;h<d;h++)f=this.children[h],g=(new Vec2(this.getChildPosition(f))).remove(f.getPosition()),g.isZero()?f.render(a):(a.save(),a.translate(g.x,g.y),f.render(a),a.restore())});d.prototype.getIndexOf=function(a){return this.children.indexOf(a)};d.prototype.getChild=function(a){return this.children[a]};
d.prototype.getChildPosition=function(a){return typeof a!=TYPE_NUMBER?a.getPosition:this.getChildPosition(this.getChild(a))};d.prototype.getChildRect=function(a){return typeof a!=TYPE_NUMBER?a.getRect():this.getChild(a).getRect()};return d};
Game.hud.views.LinearLayout=function(){var d=function(b,a){this.horizontal=b;this.rtl=a};override(d,"getPosition",function(b){typeof b!=TYPE_NUMBER&&(b=this.getIndexOf(b));var a=this.getChild(b).getPosition().clone();0<b&&a.addXY(0,this.getChildRect(b-1).bottom);return a});override(d,"getRect",function(b){typeof b!=TYPE_NUMBER&&(b=this.getIndexOf(b));var a=getChildAt(b).getRect();0<b?(b=this.getChildRect(b-1),this.horizontal?a.moveXY(rtl?-b.left:b.right,0):a.moveXY(0,rtl?-b.top:b.bottom)):rtl&&(this.horizontal?
a.moveXY(this.getRect().width()-a.width(),0):a.moveXY(0,this.getRect().height()-a.height()));return a});return d}();Game.turn={};
Game.turn.TurnManager=function(){var d=function(b){this.objects=b||[];this.lastIndex=-1;this.running=this.inObjectTurn=!1;this.turnListener=null};d.prototype.setTurnListener=function(b){this.turnListener=b};d.prototype.getTurnListener=function(){return this.turnListener};d.prototype.setObjects=function(b){if(-1!=this.lastIndex){var a=this.getObjectAt(this.lastIndex);this.objects=b;this.lastIndex=this.getObjectIndex(a)}else this.objects=b};d.prototype.getObjects=function(){return this.objects};d.prototype.getObjectAt=
function(b){return this.objects[b]};d.prototype.getObjectIndex=function(b){return this.objects.indexOf(b)};d.prototype.addObject=function(b){this.addObjectAt(this.objects.length)};d.prototype.addObjectAt=function(b,a){a<=this.lastIndex&&this.lastIndex++;this.objects.splice(a,0,b)};d.prototype.removeObject=function(b){this.removeObjectAt(this.getObjectIndex(b))};d.prototype.removeObjectAt=function(b){b<=this.lastIndex&&this.lastIndex--;this.objects.splice(b,1)};d.prototype.onFrame=function(b,a){if(this.running&&
!this.inObjectTurn){if(-2==this.lastIndex){if(this.turnListener)this.turnListener.onTurnBegin(b,this);this.lastIndex=0}else this.lastIndex++;if(this.lastIndex<this.objects.length){var d=this.getObjectAt(this.lastIndex);if(d){if(this.turnListener)this.turnListener.onObjectTurnBegin(b,this,d,this.lastIndex);d.onTurn(b,this);this.inObjectTurn=!0}}else{if(this.turnListener)this.turnListener.onTurnEnd(b,this);this.lastIndex=-2}}};d.prototype.onObjectTurnEnd=function(){this.inObjectTurn=!1;if(this.turnListener)this.turnListener.onObjectTurnEnd(gameManager,
this,this.getObjectAt(this.lastIndex),this.lastIndex)};d.prototype.stop=function(){this.running=!1};d.prototype.start=function(){this.running=!0};d.prototype.isRunning=function(){return this.running};d.prototype.isInObjectTurn=function(){return this.inObjectTurn};return d}();